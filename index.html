<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Charrington Park</title>
        <meta name="description" content="Charrington Park">
        <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
        <script>
            AFRAME.registerComponent('detect-pointer', {
                init: function () {
                    let sceneEl = this.el;

                    let cursorEl = sceneEl.querySelector('[cursor]');
                    console.log("cursorEl:", cursorEl);

                    let hasPointer = false;

                    let gamepads = navigator.getGamepads();
                    console.log("navigator.getGamepads()", gamepads);
                    for (let i=0; i<gamepads.length; ++i) {
                        checkGamepad(gamepads[i]);
                    }

                    window.addEventListener("gamepadconnected", function(e) {
                        console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                            e.gamepad.index, e.gamepad.id,
                            e.gamepad.buttons.length, e.gamepad.axes.length);
                        checkGamepad(e.gamepad);
                    });

                    function checkGamepad(gamepad) {
                        if (gamepad && gamepad.connected && gamepad.pose && gamepad.pose.hasOrientation) {
                            hasPointer = true;
                            console.log("gamepad (pointer):", gamepad);
                        } else {
                            console.log("gamepad (no pointer):", gamepad);
                        }
                        cursorEl.setAttribute('visible', !hasPointer);
                    }
                }
            });
            AFRAME.registerComponent('hash-change', {
                init: function () {
                    let baseComponent = this;
                    let sky = baseComponent.el.querySelector('a-sky');

                    this.spheres = {
                        'CharringtonPark/20171110_162651.jpg': {
                            title: "Charrington Park - Bridge - West",
                            label: "Bridge - West",
                            offset: 0
                        },
                        'CharringtonPark/20171110_163142.jpg': {
                            title: "Charrington Park - Meadow",
                            label: "Meadow",
                            offset: 0
                        },
                    };
                    this.portals = {   // angle to the left of initial center
                        'CharringtonPark/20171110_162651.jpg': {
                            'CharringtonPark/20171110_163142.jpg': 74
                        },
                        'CharringtonPark/20171110_163142.jpg': {
                            'CharringtonPark/20171110_162651.jpg': 40
                        }
                    };

                    setSphereAndPortals('CharringtonPark/20171110_162651.jpg');

                    function setSphereAndPortals(path) {
                        console.log("hashchange:", path, baseComponent.portals[path], baseComponent.el.getAttribute('src'));
                        sky.setAttribute('src', '#sphere-'+path);
                        document.title = baseComponent.spheres[path].title;

                        let oldPortals = baseComponent.el.querySelectorAll('a-entity[link]');
                        oldPortals.forEach(oldPortal => {
                            oldPortal.parentNode.removeChild(oldPortal);
                        });

                        for (portalPath in baseComponent.portals[path]) {
                            console.log("adding portal for:", portalPath);
                            let newPortal = document.createElement('a-entity');

                            let label = baseComponent.spheres[portalPath].label
                            newPortal.setAttribute('link', {href: '#' +portalPath, title: label, image: '#sphere-' + portalPath});

                            let angle = baseComponent.portals[path][portalPath];
                            let x = 8 * Math.sin((180+angle)/180*Math.PI);
                            let z = 8 * Math.cos((180+angle)/180*Math.PI);
                            newPortal.setAttribute('position', x + " 1.8 " + z);
                            newPortal.setAttribute('rotation', "0 " + angle + " 0");

                            // sound="on: click; src: #click-sound"
                            baseComponent.el.appendChild(newPortal);
                        }
                    }

                    window.addEventListener("hashchange", hashChange, false);

                    function hashChange(evt) {
                        let path = new URL(evt.newURL).hash.slice(1);
                        setSphereAndPortals(path);
                    }
               }
            });
        </script>
    </head>
  <body>
  <a-scene cursor="rayOrigin: mouse" detect-pointer hash-change>
    <a-assets>
      <img id="sphere-CharringtonPark/20171110_162651.jpg" src="CharringtonPark/20171110_162651.jpg">
      <img id="sphere-CharringtonPark/20171110_163142.jpg" src="CharringtonPark/20171110_163142.jpg">
      <audio id="click-sound" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>
    </a-assets>
    <a-sky></a-sky>
    <a-entity laser-controls="hand: right"></a-entity>
    <a-entity camera look-controls wasd-controls>
      <a-entity cursor="fuse: true; fuseTimeout=750"
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                material="color: black; shader: flat">
        <a-animation begin="click" easing="ease-in" attribute="scale" dur="150"
                     fill="forwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
        <a-animation begin="cursor-fusing" easing="ease-in" attribute="scale" dur="1500"
                     fill="backwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
      </a-entity>
    </a-entity>
  </a-scene>
  </body>
</html>
